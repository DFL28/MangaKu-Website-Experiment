<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmark - MangaKu</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <i class="fas fa-book-open"></i>
                    <h1><a href="index.html">MangaKu</a></h1>
                </div>

                <!-- Search Box -->
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Cari manga..." onkeyup="handleSearch(event)">
                    <button class="search-btn" onclick="performSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <!-- Hamburger Menu Toggle -->
                <button class="hamburger-menu-btn" onclick="toggleSideMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Search Results Dropdown -->
        <div class="search-results" id="searchResults" style="display: none;">
            <div class="container">
                <div class="search-results-content" id="searchResultsContent">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </header>

    <!-- Side Menu (Slide from Right) -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="toggleSideMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3>Menu</h3>
            <button class="close-menu-btn" onclick="toggleSideMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="side-menu-nav">
            <a href="index.html">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="index.html#genres">
                <i class="fas fa-th"></i> Genre
            </a>
            <a href="popular.html">
                <i class="fas fa-fire"></i> Populer
            </a>
            <a href="latest.html">
                <i class="fas fa-clock"></i> Terbaru
            </a>
            <a href="bookmark.html" class="active">
                <i class="fas fa-bookmark"></i> Bookmark & History
            </a>
            <!-- Login/Logout will be inserted here by JavaScript -->
            <div id="auth-menu-item"></div>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="content">
        <div class="container">
            <!-- Page Header dengan Tab Switcher -->
            <div class="section-header" style="margin-top: 2rem;">
                <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 1rem;">
                    <h2><i class="fas fa-bookmark"></i> Bookmark & History</h2>
                    <div class="tab-switcher">
                        <button class="tab-btn active" onclick="switchTab('bookmark')">
                            <i class="fas fa-bookmark"></i> Bookmark
                        </button>
                        <button class="tab-btn" onclick="switchTab('history')">
                            <i class="fas fa-history"></i> History
                        </button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="clearCurrent()" id="clearBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Hapus Semua
                    </button>
                </div>
            </div>

            <!-- Count Info -->
            <div id="countInfo" style="margin: 1rem 0; color: var(--text-muted);"></div>

            <!-- Bookmark Grid -->
            <div class="manga-grid" id="bookmarkGrid" style="display: grid;">
                <!-- Bookmarked manga will be loaded here -->
            </div>

            <!-- History Grid -->
            <div class="manga-grid" id="historyGrid" style="display: none;">
                <!-- History will be loaded here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" style="display: none; text-align: center; padding: 4rem 1rem; color: var(--text-muted);">
                <i class="fas fa-bookmark" id="emptyIcon" style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <h3 id="emptyTitle">Belum Ada Data</h3>
                <p id="emptyMessage" style="margin: 1rem 0;">Tambahkan manga favorit atau mulai baca manga!</p>
                <a href="index.html" class="btn-primary">
                    <i class="fas fa-home"></i> Kembali ke Beranda
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 MangaKu. Semua manga diambil dari sumber publik untuk tujuan edukasi.</p>
            <p>Disclaimer: Website ini hanya mirror dari berbagai sumber manga.</p>
        </div>
    </footer>

    <script src="script.js?v=20251101-bookmark"></script>
    <script>
        // ===== Auth & UI Setup =====
        const token = localStorage.getItem('token');
        let currentTab = 'bookmark';

        document.addEventListener('DOMContentLoaded', function() {
            updateAuthMenuItem(); // From script.js

            const authContainer = document.getElementById('auth-container');
            if (token) {
                authContainer.innerHTML = '<button onclick="logout()" class="btn-secondary">Logout</button>';
                loadBookmarks(); // Load data if logged in
            } else {
                authContainer.innerHTML = '<a href="login.html" class="btn-primary">Login</a>';
                showLoginWall();
            }
        });

        function logout() {
            localStorage.removeItem('token');
            updateAuthMenuItem();
            window.location.href = 'login.html';
        }

        function showLoginWall() {
            const grid = document.getElementById('bookmarkGrid');
            const emptyState = document.getElementById('emptyState');
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            document.getElementById('emptyIcon').className = 'fas fa-lock';
            document.getElementById('emptyTitle').textContent = 'Fitur Terkunci';
            document.getElementById('emptyMessage').innerHTML = 'Silakan <a href="login.html">login</a> untuk melihat bookmark dan history Anda.';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('countInfo').innerHTML = '';
        }

        // ===== API Fetch Functions =====
        async function fetchData(endpoint) {
            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 403 || response.status === 500) {
                    logout(); // Force logout on auth error
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        // ===== Load Bookmarks =====
        async function loadBookmarks() {
            try {
                const result = await fetchData('/api/user/bookmarks');
                const bookmarks = result.data;
                const grid = document.getElementById('bookmarkGrid');
                const emptyState = document.getElementById('emptyState');
                const clearBtn = document.getElementById('clearBtn');
                const countEl = document.getElementById('countInfo');

                if (bookmarks.length === 0) {
                    grid.style.display = 'none';
                    emptyState.style.display = 'block';
                    clearBtn.style.display = 'none';
                    countEl.innerHTML = '';
                    document.getElementById('emptyIcon').className = 'fas fa-bookmark';
                    document.getElementById('emptyTitle').textContent = 'Belum Ada Bookmark';
                    document.getElementById('emptyMessage').textContent = 'Tambahkan manga favorit kamu ke bookmark untuk akses cepat!';
                } else {
                    grid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    clearBtn.style.display = 'inline-flex';
                    countEl.innerHTML = `<i class="fas fa-info-circle"></i> Total: ${bookmarks.length} manga`;
                    grid.innerHTML = '';
                    bookmarks.reverse().forEach(manga => {
                        const card = createBookmarkCard(manga);
                        grid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading bookmarks:', error);
                showLoginWall();
            }
        }

        // ===== Load History =====
        async function loadHistory() {
            try {
                const result = await fetchData('/api/user/history');
                const history = result.data;
                const grid = document.getElementById('historyGrid');
                const emptyState = document.getElementById('emptyState');
                const clearBtn = document.getElementById('clearBtn');
                const countEl = document.getElementById('countInfo');

                if (history.length === 0) {
                    grid.style.display = 'none';
                    emptyState.style.display = 'block';
                    clearBtn.style.display = 'none';
                    countEl.innerHTML = '';
                    document.getElementById('emptyIcon').className = 'fas fa-history';
                    document.getElementById('emptyTitle').textContent = 'Belum Ada Riwayat';
                    document.getElementById('emptyMessage').textContent = 'Mulai baca manga untuk melihat riwayat bacaan kamu!';
                } else {
                    grid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    clearBtn.style.display = 'inline-flex';
                    countEl.innerHTML = `<i class="fas fa-info-circle"></i> Total: ${history.length} riwayat`;
                    grid.innerHTML = '';
                    history.forEach(item => {
                        const card = createHistoryCard(item);
                        grid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showLoginWall();
            }
        }

        // ===== Tab Switcher =====
        function switchTab(tab) {
            if (!token) return showLoginWall();
            currentTab = tab;
            const bookmarkGrid = document.getElementById('bookmarkGrid');
            const historyGrid = document.getElementById('historyGrid');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tab)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (tab === 'bookmark') {
                bookmarkGrid.style.display = 'grid';
                historyGrid.style.display = 'none';
                loadBookmarks();
            } else if (tab === 'history') {
                bookmarkGrid.style.display = 'none';
                historyGrid.style.display = 'grid';
                loadHistory();
            }
        }

        // ===== Add Bookmark =====
        async function addBookmark(manga) {
            if (!token) return showLoginWall();
            
            try {
                const response = await fetch('/api/user/bookmarks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ manga })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Reload bookmarks
                    if (currentTab === 'bookmark') {
                        loadBookmarks();
                    }
                } else {
                    console.error('Failed to add bookmark:', result.message);
                }
            } catch (error) {
                console.error('Error adding bookmark:', error);
            }
        }

        // ===== Remove Bookmark =====
        async function removeBookmark(mangaId, source) {
            if (!token) return showLoginWall();
            
            try {
                // For now, we'll just reload the data to reflect the change
                // In a real implementation, you would have a DELETE endpoint
                if (currentTab === 'bookmark') {
                    loadBookmarks();
                }
            } catch (error) {
                console.error('Error removing bookmark:', error);
            }
        }

        // ===== Add to History =====
        async function addToHistory(chapter) {
            if (!token) return showLoginWall();
            
            try {
                const response = await fetch('/api/user/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ chapter })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Reload history if we're on the history tab
                    if (currentTab === 'history') {
                        loadHistory();
                    }
                } else {
                    console.error('Failed to add to history:', result.message);
                }
            } catch (error) {
                console.error('Error adding to history:', error);
            }
        }

        // ===== Clear Current Tab Data =====
        async function clearCurrent() {
            if (!token) return showLoginWall();
            
            try {
                // For now, we'll just reload the data to reflect the change
                // In a real implementation, you would have a clear endpoint
                if (currentTab === 'bookmark') {
                    loadBookmarks();
                } else if (currentTab === 'history') {
                    loadHistory();
                }
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        }

        // ===== Create Bookmark Card =====
        function createBookmarkCard(manga) {
            const card = document.createElement('div');
            card.className = 'manga-card';
            card.innerHTML = `
                <div class="manga-cover">
                    <img src="${manga.cover || 'https://placehold.co/300x400?text=No+Cover'}" alt="${manga.title}" loading="lazy">
                    <button class="bookmark-remove-btn" onclick="removeBookmark('${manga.id}', '${manga.source}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="manga-info">
                    <h3 class="manga-title">${manga.title}</h3>
                    <div class="manga-meta">
                        <span class="manga-source">${manga.source}</span>
                    </div>
                    <button class="btn-primary" onclick="viewMangaDetail('${manga.id}', '${manga.source}')">
                        <i class="fas fa-eye"></i> Lihat Detail
                    </button>
                </div>
            `;
            return card;
        }

        // ===== Create History Card =====
        function createHistoryCard(item) {
            const card = document.createElement('div');
            card.className = 'manga-card';
            card.innerHTML = `
                <div class="manga-cover">
                    <img src="${item.cover || 'https://placehold.co/300x400?text=No+Cover'}" alt="${item.title}" loading="lazy">
                </div>
                <div class="manga-info">
                    <h3 class="manga-title">${item.title}</h3>
                    <div class="manga-meta">
                        <span class="manga-source">${item.source}</span>
                        <span class="manga-date">${formatDate(item.readAt)}</span>
                    </div>
                    <button class="btn-primary" onclick="viewChapter('${item.mangaId}', '${item.lastChapterId}', '${item.source}')">
                        <i class="fas fa-book-open"></i> Lanjut Baca
                    </button>
                </div>
            `;
            return card;
        }

        // ===== Helper Functions =====
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function viewMangaDetail(mangaId, source) {
            // Redirect to manga detail page
            window.location.href = `detail.html?id=${mangaId}&source=${source}`;
        }

        function viewChapter(mangaId, chapterId, source) {
            // Redirect to reader page
            window.location.href = `reader.html?mangaId=${mangaId}&chapterId=${chapterId}&source=${source}`;
        }

    </script>

    <style>
        /* Tab Switcher */
        .tab-switcher {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: none;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-btn i {
            font-size: 1rem;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Remove Button */
        .bookmark-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            z-index: 10;
            opacity: 0;
        }

        .manga-card:hover .bookmark-remove-btn {
            opacity: 1;
        }

        .bookmark-remove-btn:hover {
            background: rgb(255, 59, 48);
            transform: scale(1.1);
        }

        .manga-cover {
            position: relative;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 59, 48, 0.8);
            border-color: rgba(255, 59, 48, 1);
        }

        .manga-date {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                gap: 1rem;
            }

            .section-header > div:first-child {
                flex-direction: column;
                gap: 1rem !important;
            }

            .tab-switcher {
                width: 100%;
            }

            .tab-btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</body>
</html>